<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Reakční čas – zvukový podnět</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #2b2b2b;
      color: #ffffff;
      overscroll-behavior: none; /* méně „gumování“/posunů na mobilech */
    }

    #app {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 1rem;

      /* MAX citlivost na dotyk: zabrání zoomu/scroll gestům, která můžou „sežrat“ dotyk */
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    h1 {
      font-size: clamp(1.6rem, 2.2vw, 2.2rem);
      margin-bottom: 1rem;
    }

    #message {
      font-size: clamp(1.2rem, 1.8vw, 1.8rem);
      margin-bottom: 1.5rem;
    }

    #result {
      font-size: clamp(1.4rem, 2.2vw, 2.2rem);
      font-weight: bold;
      margin-top: 0.5rem;
    }

    #startBtn {
      font-size: clamp(1.1rem, 1.6vw, 1.6rem);
      padding: 0.8rem 1.6rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      margin-top: 1.5rem;
      background: #ffffff;
      color: #222;
      font-weight: 600;
      box-shadow: 0 0.4rem 1rem rgba(0, 0, 0, 0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.1s ease;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    #startBtn:active {
      transform: translateY(2px);
      box-shadow: 0 0.2rem 0.5rem rgba(0, 0, 0, 0.6);
      background-color: #e4e4e4;
    }

    .hint {
      margin-top: 1rem;
      font-size: 0.95rem;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Měření reakčního času – zvuk</h1>
    <div id="message">
      Klikni na <strong>Spustit test</strong>.<br>
      Počkej, až uslyšíš <strong>pípnutí</strong>, a pak se co nejrychleji dotkni obrazovky.
    </div>
    <div id="result"></div>
    <button id="startBtn">Spustit test</button>
  </div>

  <script>
    const app = document.getElementById('app');
    const messageEl = document.getElementById('message');
    const resultEl = document.getElementById('result');
    const startBtn = document.getElementById('startBtn');

    // Stav: "idle", "waiting", "ready", "done"
    let state = "idle";
    let timeoutId = null;
    let startTime = null;

    let audioCtx = null;

    // Zámek proti dvojímu vyhodnocení (např. pointerdown + pointerup, nebo různé pointer události)
    let reactedThisRound = false;

    function resetVisual() {
      resultEl.textContent = "";
      app.style.backgroundColor = "#2b2b2b";
    }

    function initAudio() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) {
          audioCtx = new AC();
        }
      }
      if (audioCtx && audioCtx.state === "suspended") {
        audioCtx.resume();
      }
    }

    function playBeep() {
      if (!audioCtx) return;
      const duration = 0.25; // s
      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      osc.frequency.value = 1000; // 1 kHz
      osc.type = "square";

      gainNode.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.4, audioCtx.currentTime + 0.01);
      gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);

      osc.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    }

    function clearPendingTimeout() {
      if (timeoutId !== null) {
        clearTimeout(timeoutId);
        timeoutId = null;
      }
    }

    function startTest() {
      initAudio();

      clearPendingTimeout();

      reactedThisRound = false;
      state = "waiting";
      resetVisual();

      // Text pro čekání – zůstane STEJNÝ před i po pípnutí
      messageEl.innerHTML = 'Čekej na <strong>pípnutí</strong>…';

      startBtn.style.display = "none";

      // Náhodné zpoždění 3–10 s
      const minDelay = 3;    // s
      const maxDelay = 10;   // s
      const delayMs = (minDelay + Math.random() * (maxDelay - minDelay)) * 1000;

      timeoutId = setTimeout(() => {
        state = "ready";
        timeoutId = null;

        // Měření co nejpřesněji: startTime hned před pípnutím
        startTime = performance.now();

        playBeep();
        // ⚠ NIC NEMĚNIT NA OBRAZOVCE!
      }, delayMs);
    }

    function handleReaction(event) {
      // maximum citlivosti + jistota, že se nevyvolá scroll/zoom apod.
      event.preventDefault();

      // Nechceme, aby tap na tlačítko spouštěl reakci na ploše (start se řeší zvlášť)
      if (event.target === startBtn) return;

      // Zámek proti dvojímu zásahu jedním dotykem (down+up nebo multi-listenery)
      if (reactedThisRound) return;
      reactedThisRound = true;

      if (state === "waiting") {
        // Klik příliš brzy
        clearPendingTimeout();
        state = "idle";
        resetVisual();
        messageEl.innerHTML = "Příliš brzy! Pípnutí ještě neznělo.";
        resultEl.textContent = "";
        startBtn.textContent = "Zkusit znovu";
        startBtn.style.display = "inline-block";

        // aby šlo znovu reagovat hned po restartu
        reactedThisRound = false;

      } else if (state === "ready") {
        const endTime = performance.now();
        const reactionTime = (endTime - startTime) / 1000;

        state = "done";
        app.style.backgroundColor = "#3498db";

        messageEl.textContent = "Tvůj reakční čas:";
        resultEl.textContent = reactionTime.toFixed(3) + " s";

        // Tlačítko zobrazit až po 0,5 s
        startBtn.style.display = "none";
        startBtn.textContent = "Spustit test znovu";
        setTimeout(() => {
          startBtn.style.display = "inline-block";
        }, 500);
      } else {
        // idle / done – nic
        reactedThisRound = false;
      }
    }

    // Start tlačítko: zastav propadnutí na app + okamžitě spustí test
    startBtn.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      e.stopPropagation();
      startTest();
    }, {passive:false});

    // MAX citlivost: poslouchej pointerdown (nejrychlejší) + pointerup jako fallback pro některá zařízení
    app.addEventListener('pointerdown', handleReaction, {passive:false});
    app.addEventListener('pointerup', handleReaction, {passive:false});
  </script>
</body>
</html>
